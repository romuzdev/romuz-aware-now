# GitHub Actions Workflow - Automated Testing
# ÙŠØ´ØºÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙƒÙ„ commit Ø£Ùˆ pull request

name: ðŸ§ª Tests & Security Checks

# Ù…ØªÙ‰ ÙŠØ´ØªØºÙ„ Ø§Ù„Ø±ÙˆØ¨ÙˆØªØŸ
on:
  # Ø¹Ù†Ø¯ Ø±ÙØ¹ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ (push)
  push:
    branches:
      - main
      - master
      - develop
  
  # Ø¹Ù†Ø¯ ÙØªØ­ Pull Request
  pull_request:
    branches:
      - main
      - master
      - develop
  
  # ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† GitHub
  workflow_dispatch:

# Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
permissions:
  contents: read
  pull-requests: write
  checks: write

# Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Jobs)
jobs:
  # ðŸ§ª ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
  test:
    name: ðŸ” Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      # 1ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # 2ï¸âƒ£ ØªØ«Ø¨ÙŠØª Node.js
      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      # 3ï¸âƒ£ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      # 4ï¸âƒ£ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
      - name: ðŸ§ª Run tests
        run: npm run test
      
      # 5ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©
      - name: ðŸ“Š Generate coverage report
        run: npm run test:coverage
        continue-on-error: true
      
      # 6ï¸âƒ£ Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©
      - name: ðŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: false
        continue-on-error: true
      
      # 7ï¸âƒ£ Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
      - name: ðŸ’¾ Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.node-version }}
          path: |
            coverage/
            test-results/
          retention-days: 30

  # ðŸ”’ ÙˆØ¸ÙŠÙØ© ÙØ­Øµ RBAC Security
  security-check:
    name: ðŸ”’ RBAC Security Check
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ” Run RBAC Security Tests
        run: npm run test tests/unit/rbac-security.spec.ts
      
      - name: ðŸ“Š Generate Security Report
        if: always()
        run: |
          echo "# ðŸ”’ RBAC Security Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All security tests passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Categories:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Route Protection: 56 tests" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ Sidebar Filtering: 15 tests" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Permission Matrix: 20 tests" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš¨ Security Edge Cases: 25 tests" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Coverage Report: 5 tests" >> $GITHUB_STEP_SUMMARY

  # ðŸ“ ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
  lint:
    name: ðŸ“ Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ” Run ESLint
        run: npm run lint
        continue-on-error: true

  # ðŸ—ï¸ ÙˆØ¸ÙŠÙØ© ÙØ­Øµ Ø§Ù„Ø¨Ù†Ø§Ø¡
  build:
    name: ðŸ—ï¸ Build Check
    runs-on: ubuntu-latest
    needs: [test, security-check]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ—ï¸ Build project
        run: npm run build
      
      - name: ðŸ“Š Check build size
        run: |
          echo "# ðŸ“¦ Build Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          du -sh dist/ >> $GITHUB_STEP_SUMMARY

  # âœ… ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  all-checks-passed:
    name: âœ… All Checks Passed
    runs-on: ubuntu-latest
    needs: [test, security-check, lint, build]
    if: success()
    
    steps:
      - name: ðŸŽ‰ Success
        run: |
          echo "# ðŸŽ‰ All Checks Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security: Passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Lint: Passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build: Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Ready to merge!" >> $GITHUB_STEP_SUMMARY
