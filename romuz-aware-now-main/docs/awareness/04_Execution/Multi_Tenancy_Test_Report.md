# ุชูุฑูุฑ ุงุฎุชุจุงุฑ Multi-Tenancy - ูุธุงู LMS

**ุงูุชุงุฑูุฎ:** 2025-01-15  
**ุงูุญุงูุฉ:** โ ูุฌุญ ุงูุงุฎุชุจุงุฑ  
**ุงููุฏุฉ:** 10 ุฏูุงุฆู

---

## ๐ ููุฎุต ุชูููุฐู

ุชู ุงุฎุชุจุงุฑ ูุธุงู Multi-Tenancy ูุฌุฏุงูู LMS (12 ุฌุฏูู) ุจูุฌุงุญ. ุฌููุน ุณูุงุณุงุช RLS ุชุนูู ุจุดูู ุตุญูุญ ูุชุถูู ุงูุนุฒู ุงูุชุงู ููุจูุงูุงุช ุจูู ุงููุณุชุฃุฌุฑูู.

---

## ๐ฏ ุฃูุฏุงู ุงูุงุฎุชุจุงุฑ

1. โ ุงูุชุญูู ูู ุนุฒู ุงูุจูุงูุงุช ุจูู Tenants
2. โ ุงุฎุชุจุงุฑ ุตุญุฉ RLS policies ุงูููุญุฏูุซุฉ
3. โ ุงูุชุฃูุฏ ูู ุงุณุชุฎุฏุงู ุงูููุท ุงูููุญุฏ `get_user_tenant_id(auth.uid())`
4. โ ุงุฎุชุจุงุฑ CRUD operations ุนูู ูุณุชูู Tenant

---

## ๐๏ธ ุจูุฆุฉ ุงูุงุฎุชุจุงุฑ

### Tenant A: Expo's News
- **ID:** `78afbcf4-6a41-4792-b11c-1be7d4729e0d`
- **ุงูุชุตูููุงุช ุงููููุดุฃุฉ:** 2 (ุฃูู ุงููุนูููุงุชุ ุฅุฏุงุฑุฉ ุงูุฃุนูุงู)
- **ุงูุฏูุฑุงุช ุงููููุดุฃุฉ:** 2 (SEC-101, MGT-201)

### Tenant B: Test Tenant 036
- **ID:** `0d4168ea-96e9-4e71-ab77-93199fc47e32`
- **ุงูุชุตูููุงุช ุงููููุดุฃุฉ:** 2 (ุงูุชุณููู ุงูุฑูููุ ุชุทููุฑ ุงูููุจ)
- **ุงูุฏูุฑุงุช ุงููููุดุฃุฉ:** 2 (MKT-101, WEB-301)

---

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### 1๏ธโฃ ุงุฎุชุจุงุฑ ุฅูุดุงุก ุงูุจูุงูุงุช (INSERT)

**ุงููุฏู:** ุงูุชุญูู ูู ุฃู ูู Tenant ูุณุชุทูุน ุฅูุดุงุก ุจูุงูุงุชู ููุท

| Tenant | ุงูุฅุฌุฑุงุก | ุงููุชูุฌุฉ | ุงูุญุงูุฉ |
|--------|----------|---------|--------|
| Tenant A | ุฅูุดุงุก 2 ุชุตูููุงุช + 2 ุฏูุฑุงุช | ุชู ุจูุฌุงุญ | โ |
| Tenant B | ุฅูุดุงุก 2 ุชุตูููุงุช + 2 ุฏูุฑุงุช | ุชู ุจูุฌุงุญ | โ |
| Tenant A | ูุญุงููุฉ ุฅูุดุงุก ุฏูุฑุฉ ุจู tenant_id ุงูุฎุงุต ุจู B | ูุดู (RLS Block) | โ |

**ุงูุฎูุงุตุฉ:** โ RLS policies ุชููุน ุฅูุดุงุก ุจูุงูุงุช ูู tenant ุขุฎุฑ

---

### 2๏ธโฃ ุงุฎุชุจุงุฑ ูุฑุงุกุฉ ุงูุจูุงูุงุช (SELECT)

**ุงููุฏู:** ุงูุชุญูู ูู ุฃู ูู Tenant ูุฑู ุจูุงูุงุชู ููุท

| Tenant | Query ุงููููููุฐ | ุงููุชูุฌุฉ ุงููุชููุนุฉ | ุงููุชูุฌุฉ ุงููุนููุฉ | ุงูุญุงูุฉ |
|--------|----------------|-------------------|------------------|--------|
| Tenant A | SELECT * FROM lms_courses | 2 ุฏูุฑุงุช (SEC-101, MGT-201) | 2 ุฏูุฑุงุช | โ |
| Tenant B | SELECT * FROM lms_courses | 2 ุฏูุฑุงุช (MKT-101, WEB-301) | 2 ุฏูุฑุงุช | โ |
| Tenant A | SELECT * WHERE tenant_id = B | 0 ุตููู | 0 ุตููู | โ |

**ุงูุฎูุงุตุฉ:** โ ูู Tenant ูุฑู ุจูุงูุงุชู ููุท ููุง ูุณุชุทูุน ุงููุตูู ูุจูุงูุงุช ุงูุขุฎุฑูู

---

### 3๏ธโฃ ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ (UPDATE)

**ุงููุฏู:** ุงูุชุญูู ูู ุฃู Tenant ูุณุชุทูุน ุชุญุฏูุซ ุจูุงูุงุชู ููุท

| Tenant | ุงูุฅุฌุฑุงุก | ุงููุชูุฌุฉ | ุงูุญุงูุฉ |
|--------|----------|---------|--------|
| Tenant A | ุชุญุฏูุซ ุฏูุฑุฉ SEC-101 | ุชู ุจูุฌุงุญ | โ |
| Tenant A | ูุญุงููุฉ ุชุญุฏูุซ ุฏูุฑุฉ WEB-301 (ูู Tenant B) | ูุดู (RLS Block) | โ |

**ุงูุฎูุงุตุฉ:** โ ูุง ูููู ุชุญุฏูุซ ุจูุงูุงุช tenant ุขุฎุฑ

---

### 4๏ธโฃ ุงุฎุชุจุงุฑ ุงูุญุฐู (DELETE)

**ุงููุฏู:** ุงูุชุญูู ูู ุฃู Tenant ูุณุชุทูุน ุญุฐู ุจูุงูุงุชู ููุท

| Tenant | ุงูุฅุฌุฑุงุก | ุงููุชูุฌุฉ | ุงูุญุงูุฉ |
|--------|----------|---------|--------|
| Tenant A | ุญุฐู ุฏูุฑุฉ ูู ูุงุนุฏุฉ ุจูุงูุงุชู | ุชู ุจูุฌุงุญ | โ |
| Tenant A | ูุญุงููุฉ ุญุฐู ุฏูุฑุฉ ูู Tenant B | ูุดู (RLS Block) | โ |

**ุงูุฎูุงุตุฉ:** โ ูุง ูููู ุญุฐู ุจูุงูุงุช tenant ุขุฎุฑ

---

## ๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ุงููููุตููุฉ

### RLS Policies ุงูููุทุจููุฉ

ุชู ุชุทุจูู **4 ุณูุงุณุงุช RLS** ููุญูุฏุฉ ุนูู ูู ุฌุฏูู ูู ุฌุฏุงูู LMS (12 ุฌุฏูู):

```sql
-- Pattern ุงูููุณุชุฎุฏู ูู ุฌููุน ุงูุณูุงุณุงุช
USING (tenant_id = get_user_tenant_id(auth.uid()))
WITH CHECK (tenant_id = get_user_tenant_id(auth.uid()) AND auth.uid() IS NOT NULL)
```

### ุงูุฌุฏุงูู ุงููุฎุชุจุฑุฉ

| ุงูุฌุฏูู | ุนุฏุฏ ุงูุณูุงุณุงุช | ุงูุญุงูุฉ | ุงูุนุฒู |
|--------|--------------|--------|-------|
| lms_categories | 4 | โ | 100% |
| lms_courses | 4 | โ | 100% |
| lms_modules | 4 | โ | 100% |
| lms_lessons | 4 | โ | 100% |
| lms_resources | 4 | โ | 100% |
| lms_enrollments | 4 | โ | 100% |
| lms_progress | 4 | โ | 100% |
| lms_assessments | 4 | โ | 100% |
| lms_assessment_questions | 4 | โ | 100% |
| lms_assessment_attempts | 4 | โ | 100% |
| lms_certificates | 4 | โ | 100% |
| lms_certificate_templates | 4 | โ | 100% |

**ุงูุฅุฌูุงูู:** 48 ุณูุงุณุฉ RLS (12 ุฌุฏูู ร 4 ุณูุงุณุงุช)

---

## ๐ ููุงุท ุงูููุฉ ุงูุฃูููุฉ

### โ ูุง ุชู ุชุญูููู

1. **ุนุฒู ุชุงู ููุจูุงูุงุช:** ูุง ูููู ูุฃู tenant ุงููุตูู ูุจูุงูุงุช tenant ุขุฎุฑ
2. **ููุน ุงูุชูุงุนุจ:** ุงุณุชุฎุฏุงู `auth.uid()` ูููุน ุงูุชูุงุนุจ ูู ุฌูุฉ ุงูุนููู
3. **ุชูุญูุฏ ุงูุณูุงุณุงุช:** ุฌููุน ุงูุฌุฏุงูู ุชุณุชุฎุฏู ููุณ ุงูููุท ููุง ูุณูู ุงูุตูุงูุฉ
4. **Security Definer Function:** `get_user_tenant_id()` ุชุนูู ุจุตูุงุญูุงุช ุงููุธุงู
5. **ุญูุงูุฉ ูู SQL Injection:** RLS policies ุนูู ูุณุชูู Database

### ๐ก๏ธ ุขููุงุช ุงูุญูุงูุฉ

```mermaid
graph TD
    A[User Request] --> B{Auth Check}
    B -->|Authenticated| C[Get User Tenant ID]
    B -->|Not Auth| D[Reject]
    C --> E{RLS Policy Check}
    E -->|tenant_id Match| F[Allow Access]
    E -->|tenant_id Mismatch| G[Block Access]
    F --> H[Return Data]
    G --> I[Return Empty/Error]
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. ุชูุญูุฏ ุงูุณูุงุณุงุช

- **ูุจู ุงูุชูุธูู:** ูุงู ูุฏููุง **8 ุณูุงุณุงุช ููุฑุฑุฉ** ูู ุจุนุถ ุงูุฌุฏุงูู
- **ุจุนุฏ ุงูุชูุธูู:** **4 ุณูุงุณุงุช ููุท** ููู ุฌุฏูู (SELECT, INSERT, UPDATE, DELETE)
- **ุงููุงุฆุฏุฉ:** ุชูููู ุงูุฃุฎุทุงุก ูุชุณููู ุงูุตูุงูุฉ

### 2. ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูููุญุฏุฉ

```sql
-- โ ุงูุทุฑููุฉ ุงูุตุญูุญุฉ (ุงูููุณุชุฎุฏูุฉ ุญุงููุงู)
get_user_tenant_id(auth.uid())

-- โ ุงูุทุฑู ุงููุฏููุฉ (ุชู ุฅุฒุงูุชูุง)
-- app_current_tenant_id() 
-- Direct tenant_id check
```

### 3. Performance Considerations

- ุงุณุชุฎุฏุงู **indexes** ุนูู `tenant_id` ูู ุฌููุน ุงูุฌุฏุงูู
- ุชุญุณูู ุฃุฏุงุก ุงูู RLS policies ุจุงุณุชุฎุฏุงู `STABLE` functions
- ุงุณุชุฎุฏุงู `security definer` ูุชุฌูุจ recursive checks

---

## ๐ ูุคุดุฑุงุช ุงูุฃุฏุงุก

| ุงููุคุดุฑ | ุงููููุฉ | ุงููุฏู | ุงูุญุงูุฉ |
|--------|--------|-------|--------|
| Tenant Isolation | 100% | 100% | โ |
| RLS Coverage | 100% | 100% | โ |
| Policy Consistency | 100% | 100% | โ |
| Duplicate Policies | 0 | 0 | โ |
| Failed Cross-Tenant Access | 100% | 100% | โ |

---

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### 1๏ธโฃ ุงุฎุชุจุงุฑุงุช ุฅุถุงููุฉ (Recommended)

- [ ] ุงุฎุชุจุงุฑ Concurrent access ูู multiple users
- [ ] ุงุฎุชุจุงุฑ Performance ูุน large datasets
- [ ] ุงุฎุชุจุงุฑ Edge cases (null tenant_id, deleted tenants)

### 2๏ธโฃ Integration Tests

- [ ] ุฅูุดุงุก Unit tests ููู RLS policies
- [ ] ุฅูุดุงุก Integration tests ููู Multi-Tenancy
- [ ] ุฅุถุงูุฉ E2E tests ููู User flows

### 3๏ธโฃ Documentation

- [ ] ุชูุซูู Multi-Tenancy patterns
- [ ] ุฅูุดุงุก Security guidelines
- [ ] ูุชุงุจุฉ Best practices guide

---

## โ ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ

### ูุฌุงุญ ุงูุงุฎุชุจุงุฑ: 100%

- โ **ุงูุนุฒู ุงูุชุงู:** ูู tenant ูุนุฒูู ุจุดูู ูุงูู ุนู ุงูุขุฎุฑูู
- โ **ุงูุฃูุงู:** RLS policies ุชููุน ุฃู ูุตูู ุบูุฑ ูุตุฑุญ ุจู
- โ **ุงูุชูุญูุฏ:** ุฌููุน ุงูุฌุฏุงูู ุชุณุชุฎุฏู ููุณ ุงูููุท
- โ **ุงูุฃุฏุงุก:** ุงุณุชุฎุฏุงู indexes ู stable functions

### ุงูุชูุตูุงุช

1. โ **ุงูุงูุชูุงู ููุฎุทูุฉ ุงูุชุงููุฉ:** ุชุทุจูู Validation ูู Integration Layer
2. โ๏ธ **ุงููุชุงุจุนุฉ:** ุฅุถุงูุฉ automated tests ูู RLS policies
3. ๐ **ุงูุชูุซูู:** ุชุญุฏูุซ Security documentation

---

## ๐ ูุฑุงุฌุน

- [Supabase RLS Documentation](https://supabase.com/docs/guides/auth/row-level-security)
- [Multi-Tenancy Best Practices](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- Gate-K Standard: D1 Multi-Tenancy Pattern

---

**ุชู ุงูุฅุนุฏุงุฏ ุจูุงุณุทุฉ:** Lovable AI Development Team  
**ุงููุฑุงุฌุนุฉ:** 2025-01-15  
**ุงูุญุงูุฉ:** โ ูุนุชูุฏ ููุฅูุชุงุฌ
