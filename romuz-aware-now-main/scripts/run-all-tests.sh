#!/bin/bash

# =====================================================
# ุณูุฑูุจุช ุชุดุบูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช - Romuz System
# =====================================================
# ูููู ุจุชุดุบูู ุฌููุน ุฃููุงุน ุงูุงุฎุชุจุงุฑุงุช ุจุดูู ูุชุณูุณู
# =====================================================

set -e

echo "๐ ุจุฏุก ุชุดุบูู ุฌููุน ุงุฎุชุจุงุฑุงุช ูุธุงู Romuz..."
echo "================================================================="
echo ""

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Counters
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0
WARNINGS=0

# Functions
log_section() {
    echo ""
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}๐ $1${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
}

log_success() {
    echo -e "${GREEN}โ $1${NC}"
    ((PASSED_TESTS++))
}

log_error() {
    echo -e "${RED}โ $1${NC}"
    ((FAILED_TESTS++))
}

log_warning() {
    echo -e "${YELLOW}โ๏ธ  $1${NC}"
    ((WARNINGS++))
}

log_info() {
    echo -e "${BLUE}โน๏ธ  $1${NC}"
}

# =====================================================
# Phase 1: Pre-Test Setup
# =====================================================
log_section "ุงููุฑุญูุฉ 0: ุงูุฅุนุฏุงุฏ ูุงูุชุญูู"

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
    log_warning "node_modules ุบูุฑ ููุฌูุฏุฉ. ุณูุชู ุชุซุจูุช ุงูููุชุจุงุช..."
    npm install
fi

# Check if Playwright is installed
if ! command -v playwright &> /dev/null; then
    log_warning "Playwright ุบูุฑ ูุซุจุช. ุณูุชู ุงูุชุซุจูุช..."
    npx playwright install
fi

log_success "ุชู ุงูุชุญูู ูู ุงูุจูุฆุฉ"

# =====================================================
# Phase 1: Unit Tests
# =====================================================
log_section "ุงููุฑุญูุฉ 1: ุงุฎุชุจุงุฑุงุช ุงููุญุฏุงุช (Unit Tests)"
log_info "ุงุฎุชุจุงุฑ Components, Hooks, Utilities..."

if npm run test:unit 2>&1 | tee /tmp/unit-test.log; then
    log_success "ุงุฎุชุจุงุฑุงุช ุงููุญุฏุงุช ูุฌุญุช"
else
    log_error "ุงุฎุชุจุงุฑุงุช ุงููุญุฏุงุช ูุดูุช"
    echo ""
    echo "๐ ุณุฌู ุงูุฃุฎุทุงุก:"
    tail -20 /tmp/unit-test.log
fi

# =====================================================
# Phase 2: Integration Tests
# =====================================================
log_section "ุงููุฑุญูุฉ 2: ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู (Integration Tests)"
log_info "ุงุฎุชุจุงุฑ RLS, Database Constraints, APIs..."

if npm run test:integration 2>&1 | tee /tmp/integration-test.log; then
    log_success "ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู ูุฌุญุช"
else
    log_error "ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู ูุดูุช"
    echo ""
    echo "๐ ุณุฌู ุงูุฃุฎุทุงุก:"
    tail -20 /tmp/integration-test.log
fi

# =====================================================
# Phase 3: E2E Tests
# =====================================================
log_section "ุงููุฑุญูุฉ 3: ุงุฎุชุจุงุฑุงุช End-to-End (E2E Tests)"
log_info "ุงุฎุชุจุงุฑ User Flows ุงููุงููุฉ..."

# Check if E2E tests exist
if [ -f "tests/e2e/admin.flow.spec.ts" ]; then
    if npx playwright test 2>&1 | tee /tmp/e2e-test.log; then
        log_success "ุงุฎุชุจุงุฑุงุช E2E ูุฌุญุช"
    else
        log_error "ุงุฎุชุจุงุฑุงุช E2E ูุดูุช"
        echo ""
        echo "๐ ุณุฌู ุงูุฃุฎุทุงุก:"
        tail -20 /tmp/e2e-test.log
    fi
else
    log_warning "ูููุงุช ุงุฎุชุจุงุฑุงุช E2E ุบูุฑ ููุฌูุฏุฉ. ุณูุชู ุชุฎุทู ูุฐู ุงููุฑุญูุฉ."
    log_info "ูุฅูุดุงุก ุงูุงุฎุชุจุงุฑุงุชุ ุฑุงุฌุน: docs/awareness/05_QA/Comprehensive_Testing_Plan_AR.md"
fi

# =====================================================
# Phase 4: Security Tests
# =====================================================
log_section "ุงููุฑุญูุฉ 4: ุงุฎุชุจุงุฑุงุช ุงูุฃูุงู (Security Tests)"
log_info "ุงุฎุชุจุงุฑ RLS Policies, RBAC, Authentication..."

if npm run test:security 2>&1 | tee /tmp/security-test.log; then
    log_success "ุงุฎุชุจุงุฑุงุช ุงูุฃูุงู ูุฌุญุช"
else
    log_error "ุงุฎุชุจุงุฑุงุช ุงูุฃูุงู ูุดูุช - ูุฐุง ุฎุทูุฑ! โ๏ธ"
    echo ""
    echo "๐ ุณุฌู ุงูุฃุฎุทุงุก:"
    tail -20 /tmp/security-test.log
    echo ""
    log_error "ูุฌุจ ูุนุงูุฌุฉ ูุดุงูู ุงูุฃูุงู ูุจู ุงููุชุงุจุนุฉ!"
fi

# =====================================================
# Phase 5: Performance Tests
# =====================================================
log_section "ุงููุฑุญูุฉ 5: ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก (Performance Tests)"
log_info "ููุงุณ ุฃููุงุช ุงูุงุณุชุฌุงุจุฉ ูุฃุฏุงุก ุงููุธุงู..."

if [ -f "tests/sanity/performance.sanity.ts" ]; then
    if npm run test:performance 2>&1 | tee /tmp/performance-test.log; then
        log_success "ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก ูุฌุญุช"
    else
        log_warning "ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก ุฃุธูุฑุช ูุดุงูู (ุบูุฑ ุญุฑุฌุฉ)"
    fi
else
    log_warning "ูููุงุช ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก ุบูุฑ ููุฌูุฏุฉ. ุณูุชู ุชุฎุทู ูุฐู ุงููุฑุญูุฉ."
fi

# =====================================================
# Phase 6: Sanity Checks
# =====================================================
log_section "ุงููุฑุญูุฉ 6: ูุญูุตุงุช ุงูุณูุงูุฉ (Sanity Checks)"
log_info "ูุญุต ุณุฑูุน ููุชุฃูุฏ ูู ุตุญุฉ ุงููุธุงู..."

if [ -f "tests/sanity/run-all.ts" ]; then
    if node tests/sanity/run-all.ts 2>&1 | tee /tmp/sanity-test.log; then
        log_success "ูุญูุตุงุช ุงูุณูุงูุฉ ูุฌุญุช"
    else
        log_warning "ูุญูุตุงุช ุงูุณูุงูุฉ ุฃุธูุฑุช ุชุญุฐูุฑุงุช"
    fi
else
    log_warning "ูููุงุช ูุญูุตุงุช ุงูุณูุงูุฉ ุบูุฑ ููุฌูุฏุฉ. ุณูุชู ุชุฎุทู ูุฐู ุงููุฑุญูุฉ."
fi

# =====================================================
# Phase 7: Coverage Report
# =====================================================
log_section "ุงููุฑุญูุฉ 7: ุชูุฑูุฑ ุงูุชุบุทูุฉ (Coverage Report)"
log_info "ุชูููุฏ ุชูุฑูุฑ ุชุบุทูุฉ ุงูููุฏ..."

if npm run test:coverage 2>&1 | tee /tmp/coverage-test.log; then
    log_success "ุชู ุชูููุฏ ุชูุฑูุฑ ุงูุชุบุทูุฉ"
    
    # Extract coverage percentage
    COVERAGE=$(grep -oP '\d+(?=%)' /tmp/coverage-test.log | head -1)
    
    if [ ! -z "$COVERAGE" ]; then
        if [ "$COVERAGE" -ge 70 ]; then
            log_success "ุชุบุทูุฉ ุงูููุฏ: ${COVERAGE}% (ููุชุงุฒ โ)"
        elif [ "$COVERAGE" -ge 50 ]; then
            log_warning "ุชุบุทูุฉ ุงูููุฏ: ${COVERAGE}% (ุฌูุฏุ ูุญุชุงุฌ ุชุญุณูู)"
        else
            log_error "ุชุบุทูุฉ ุงูููุฏ: ${COVERAGE}% (ููุฎูุถ ุฌุฏุงู!)"
        fi
    fi
else
    log_warning "ูุดู ุชูููุฏ ุชูุฑูุฑ ุงูุชุบุทูุฉ"
fi

# =====================================================
# Final Summary
# =====================================================
echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ ููุฎุต ุงููุชุงุฆุฌ${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# Calculate totals
TOTAL_TESTS=$((PASSED_TESTS + FAILED_TESTS))
if [ $TOTAL_TESTS -gt 0 ]; then
    PASS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
else
    PASS_RATE=0
fi

echo -e "โ ุงูุงุฎุชุจุงุฑุงุช ุงููุงุฌุญุฉ: ${GREEN}$PASSED_TESTS${NC}"
echo -e "โ ุงูุงุฎุชุจุงุฑุงุช ุงููุงุดูุฉ: ${RED}$FAILED_TESTS${NC}"
echo -e "โ๏ธ  ุงูุชุญุฐูุฑุงุช: ${YELLOW}$WARNINGS${NC}"
echo -e "๐ ูุณุจุฉ ุงููุฌุงุญ: ${PASS_RATE}%"
echo ""

# Overall status
if [ $FAILED_TESTS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${GREEN}โ                                                               โ${NC}"
    echo -e "${GREEN}โ  ๐ ููุชุงุฒ! ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช ุจุฏูู ุฃู ูุดุงูู!              โ${NC}"
    echo -e "${GREEN}โ                                                               โ${NC}"
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
elif [ $FAILED_TESTS -eq 0 ]; then
    echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${YELLOW}โ                                                               โ${NC}"
    echo -e "${YELLOW}โ  โ ุฌูุฏ! ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช ููู ููุงู ุจุนุถ ุงูุชุญุฐูุฑุงุช              โ${NC}"
    echo -e "${YELLOW}โ                                                               โ${NC}"
    echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
else
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${RED}โ                                                               โ${NC}"
    echo -e "${RED}โ  โ ููุงู ุงุฎุชุจุงุฑุงุช ูุงุดูุฉ ุชุญุชุงุฌ ุฅูู ูุนุงูุฌุฉ!                    โ${NC}"
    echo -e "${RED}โ                                                               โ${NC}"
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
fi

echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

echo "๐ ูุนุฑุถ ุชูุฑูุฑ ุงูุชุบุทูุฉ ุงูุชูุตููู:"
echo "   npx vitest --coverage --ui"
echo ""

echo "๐ญ ูุนุฑุถ ุชูุฑูุฑ Playwright (E2E):"
echo "   npx playwright show-report"
echo ""

echo "๐ ูุชุตุญูุญ ุงุฎุชุจุงุฑ ูุญุฏุฏ:"
echo "   npx playwright test --debug [test-file]"
echo ""

echo "๐ ูููุฒูุฏ ูู ุงููุนูููุงุชุ ุฑุงุฌุน:"
echo "   docs/awareness/05_QA/Comprehensive_Testing_Plan_AR.md"
echo ""

# Exit with appropriate code
if [ $FAILED_TESTS -gt 0 ]; then
    exit 1
else
    exit 0
fi
