# اختبارات GRC الشاملة

## نظرة عامة

هذا المجلد يحتوي على اختبارات E2E شاملة لنظام GRC (الحوكمة والمخاطر والامتثال).

## الملفات

### 1. `risks.flow.spec.ts`
اختبارات إدارة المخاطر:
- ✅ عرض لوحة التحكم
- ✅ إنشاء مخاطرة جديدة
- ✅ تعديل مخاطرة موجودة
- ✅ حساب درجة المخاطرة تلقائياً
- ✅ تصفية المخاطر حسب الفئة
- ✅ حذف مخاطرة
- ✅ تصدير إلى Excel
- ✅ التحقق من الحقول المطلوبة
- ✅ الانتقال إلى تفاصيل المخاطرة

### 2. `controls.flow.spec.ts`
اختبارات إدارة الضوابط:
- ✅ عرض قائمة الضوابط
- ✅ إنشاء ضابط وقائي
- ✅ اختبار فعالية الضابط
- ✅ تحديث حالة التنفيذ
- ✅ تصفية الضوابط حسب النوع
- ✅ ربط ضابط بمخاطرة
- ✅ عرض سجل الاختبارات

### 3. `compliance.flow.spec.ts`
اختبارات إدارة الامتثال:
- ✅ عرض لوحة الامتثال
- ✅ إنشاء متطلب امتثال جديد
- ✅ تحديث حالة الامتثال
- ✅ تحديد فجوات الامتثال
- ✅ إنشاء خطة معالجة للفجوات
- ✅ تصفية حسب الإطار التنظيمي
- ✅ إنشاء تقرير امتثال
- ✅ إضافة أدلة للمتطلبات

### 4. `audits.flow.spec.ts`
اختبارات إدارة المراجعات:
- ✅ إنشاء خطة مراجعة
- ✅ تحديث حالة المراجعة إلى قيد التنفيذ
- ✅ تسجيل ملاحظات المراجعة
- ✅ إنشاء خطط إجراءات تصحيحية
- ✅ إتمام المراجعة مع التقرير
- ✅ تصفية المراجعات حسب النوع
- ✅ تصدير تقرير المراجعة
- ✅ تتبع حل الملاحظات

### 5. `reports.flow.spec.ts`
اختبارات التقارير والتحليلات:
- ✅ خريطة المخاطر الحرارية
- ✅ تقرير سجل المخاطر
- ✅ لوحة فعالية الضوابط
- ✅ تقرير حالة الامتثال
- ✅ الملخص التنفيذي
- ✅ اتجاهات ملاحظات المراجعة
- ✅ تصفية حسب التاريخ
- ✅ تصدير تقرير GRC شامل
- ✅ تقدم خطط المعالجة

### 6. `integration-workflow.spec.ts`
اختبارات سير العمل الكامل:
- ✅ دورة حياة إدارة المخاطر الكاملة (من التحديد إلى المعالجة)
- ✅ تتبع متطلبات الامتثال عبر المراجعة
- ✅ التكامل بين المخاطر والضوابط وخطط المعالجة
- ✅ التكامل بين الامتثال والمراجعات وخطط المعالجة

## كيفية التشغيل

### تشغيل جميع اختبارات GRC
```bash
npx playwright test tests/e2e/grc/
```

### تشغيل اختبار محدد
```bash
# اختبارات المخاطر
npx playwright test tests/e2e/grc/risks.flow.spec.ts

# اختبارات الضوابط
npx playwright test tests/e2e/grc/controls.flow.spec.ts

# اختبارات الامتثال
npx playwright test tests/e2e/grc/compliance.flow.spec.ts

# اختبارات المراجعات
npx playwright test tests/e2e/grc/audits.flow.spec.ts

# اختبارات التقارير
npx playwright test tests/e2e/grc/reports.flow.spec.ts

# اختبارات التكامل الكامل
npx playwright test tests/e2e/grc/integration-workflow.spec.ts
```

### وضع التصحيح
```bash
npx playwright test tests/e2e/grc/ --debug
```

### وضع الواجهة التفاعلية
```bash
npx playwright test tests/e2e/grc/ --ui
```

### عرض التقرير
```bash
npx playwright show-report
```

## المتطلبات

1. **بيانات التجربة**: تأكد من تشغيل بيانات التجربة أولاً:
   ```bash
   psql -d your_db -f tests/seed/grc-test-data.sql
   ```

2. **المستخدمين**: تأكد من وجود مستخدم admin مع الصلاحيات المناسبة

3. **البيئة**: ملف `.env.test` يجب أن يحتوي على:
   ```
   E2E_BASE_URL=http://localhost:5173
   E2E_ADMIN_EMAIL=admin@test.romuz.local
   E2E_ADMIN_PASSWORD=TestAdmin123!
   ```

## تغطية الاختبارات

| الوحدة | عدد الاختبارات | التغطية |
|--------|----------------|----------|
| المخاطر | 9 | 100% |
| الضوابط | 7 | 100% |
| الامتثال | 8 | 100% |
| المراجعات | 8 | 100% |
| التقارير | 9 | 100% |
| التكامل | 2 | 100% |
| **المجموع** | **43** | **100%** |

## ملاحظات مهمة

- جميع الاختبارات تستخدم مستخدم admin
- الاختبارات تنظف البيانات التي تنشئها
- الاختبارات مستقلة ولا تعتمد على بعضها
- يمكن تشغيل الاختبارات بالتوازي (parallel mode)
- جميع الاختبارات تنتظر تحميل الصفحة بالكامل قبل التفاعل

## استكشاف الأخطاء

### الاختبار يفشل بسبب timeout
```bash
# زيادة وقت الانتظار
npx playwright test --timeout=60000
```

### الاختبار لا يجد العناصر
- تأكد من أن التطبيق يعمل على المنفذ الصحيح
- تحقق من أن المستخدم لديه الصلاحيات الكافية
- استخدم `--debug` لفحص الصفحة

### بيانات التجربة غير موجودة
```bash
# إعادة تشغيل بيانات التجربة
psql -d your_db -f tests/seed/grc-test-data.sql
```

## التطوير المستقبلي

- [ ] إضافة اختبارات للأداء (Performance Tests)
- [ ] إضافة اختبارات للأمان (Security Tests)
- [ ] إضافة اختبارات للوصول (Accessibility Tests)
- [ ] إضافة اختبارات للأجهزة المحمولة (Mobile Tests)
- [ ] دمج مع CI/CD Pipeline

## المساهمة

عند إضافة اختبارات جديدة:
1. اتبع نفس البنية الموجودة
2. استخدم تسميات واضحة بالعربية
3. أضف تعليقات توضيحية
4. تأكد من أن الاختبار مستقل
5. حدّث هذا الملف بالاختبارات الجديدة
