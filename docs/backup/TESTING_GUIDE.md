# ๐งช ุฏููู ุงูุงุฎุชุจุงุฑ ุงูุดุงูู - ูุธุงู ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ

## ๐ ูุธุฑุฉ ุนุงูุฉ
ูุฐุง ุงูุฏููู ูุบุทู ุฌููุน ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ ููุธุงู M23 - Backup & Recovery

---

## โ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑ ุงูุดุงููุฉ

### 1๏ธโฃ ุงุฎุชุจุงุฑ ุฅูุดุงุก ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ

#### ุงูุงุฎุชุจุงุฑ 1.1: ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ (Full Backup)
**ุงููุฏู:** ุงูุชุฃูุฏ ูู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ ุจูุฌุงุญ

**ุงูุฎุทูุงุช:**
1. ุงูุชูู ุฅูู `/platform/admin/backup`
2. ุงุถุบุท ุนูู "ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฌุฏูุฏุฉ +"
3. ุงุฎุชุฑ ููุน ุงููุณุฎุฉ: "ูุณุฎุฉ ูุงููุฉ (Full)"
4. ุฃุฏุฎู ุงุณู ุงููุณุฎุฉ: `test-full-backup-{timestamp}`
5. ุฃุฏุฎู ูุตู: `ุงุฎุชุจุงุฑ ุงููุณุฎุฉ ุงููุงููุฉ`
6. ุงุถุบุท "ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ"

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- โ ุธููุฑ ุฑุณุงูุฉ ูุฌุงุญ: "ุชู ุจุฏุก ุงููุณุฎ ุงูุงุญุชูุงุทู"
- โ ุธููุฑ ุงูุณุฌู ูู ุงูุฌุฏูู ุจุญุงูุฉ "running"
- โ ุจุนุฏ ุซูุงููุ ุชุบููุฑ ุงูุญุงูุฉ ุฅูู "completed"
- โ ุธููุฑ ุญุฌู ุงููุณุฎุฉ ูุงููุฏุฉ ุงูุฒูููุฉ
- โ ูุฌูุฏ ูุณุงุฑ ุงูุชุฎุฒูู ูู Storage

**ูุนุงููุฑ ุงููุฌุงุญ:**
- ุงูุญุงูุฉ ุงูููุงุฆูุฉ: `completed`
- ุงูุญุฌู: > 0 bytes
- ุงููุฏุฉ: < 30 ุซุงููุฉ
- ุนุฏุฏ ุงูุฌุฏุงูู: 18 ุฌุฏูู ุนูู ุงูุฃูู

---

#### ุงูุงุฎุชุจุงุฑ 1.2: ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุชุฒุงูุฏูุฉ (Incremental Backup)
**ุงูุฎุทูุงุช:**
1. ููุณ ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ 1.1
2. ุงุฎุชุฑ ููุน ุงููุณุฎุฉ: "ูุณุฎุฉ ุชุฒุงูุฏูุฉ (Incremental)"

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- โ ููุณ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ 1.1
- โ ุญุฌู ุงููุณุฎุฉ ุฃุตุบุฑ ูู ุงููุณุฎุฉ ุงููุงููุฉ

---

#### ุงูุงุฎุชุจุงุฑ 1.3: ูุณุฎุฉ ูุญุธูุฉ (Snapshot)
**ุงูุฎุทูุงุช:**
1. ููุณ ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ 1.1
2. ุงุฎุชุฑ ููุน ุงููุณุฎุฉ: "ูุณุฎุฉ ูุญุธูุฉ (Snapshot)"

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- โ ุฅูุดุงุก ุฃุณุฑุน ูู ุงููุณุฎุฉ ุงููุงููุฉ
- โ ุญุงูุฉ completed ุจุณุฑุนุฉ

---

### 2๏ธโฃ ุงุฎุชุจุงุฑ ุฌุฏููุฉ ุงููุณุฎ ุงูุชููุงุฆูุฉ

#### ุงูุงุฎุชุจุงุฑ 2.1: ุฅูุดุงุก ุฌุฏููุฉ ููููุฉ
**ุงููุฏู:** ุงูุชุฃูุฏ ูู ุนูู ูุธุงู ุงูุฌุฏููุฉ

**ุงูุฎุทูุงุช:**
1. ุงูุชูู ุฅูู ุชุจููุจ "ุงูุฌุฏููุฉ ุงูุชููุงุฆูุฉ"
2. ุงุถุบุท "ุฌุฏููุฉ ุฌุฏูุฏุฉ +"
3. ุงููุฃ ุงูุจูุงูุงุช:
   - ุงูุงุณู: `daily-backup-2am`
   - ุงูููุน: Full
   - Cron: `0 2 * * *` (ูู ููู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู)
   - ุงููุตู: `ูุณุฎุฉ ููููุฉ ุชููุงุฆูุฉ`
   - ุงูุงุญุชูุงุธ: 30 ููู
   - ุงูุญุฏ ุงูุฃูุตู: 10 ูุณุฎ
4. ุงุถุบุท "ุฅูุดุงุก ุฌุฏููุฉ"

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- โ ุธููุฑ ุฑุณุงูุฉ: "ุชู ุฅูุดุงุก ุงูุฌุฏููุฉ"
- โ ุธููุฑ ุงูุฌุฏููุฉ ูู ุงููุงุฆูุฉ
- โ ุงูุญุงูุฉ: ููุนูู (enabled)
- โ ุนุฑุถ ุงูููุช ุงูุชุงูู ููุชูููุฐ

**ููุงุญุธุฉ:** ูุง ูููู ุงุฎุชุจุงุฑ ุงูุชูููุฐ ุงููุนูู ุฅูุง ุจุนุฏ ุฅุนุฏุงุฏ Cron Job (ุฑุงุฌุน ุงููุณู 5)

---

#### ุงูุงุฎุชุจุงุฑ 2.2: ุชุนุทูู/ุชูุนูู ุฌุฏููุฉ
**ุงูุฎุทูุงุช:**
1. ุงุนุซุฑ ุนูู ุงูุฌุฏููุฉ ุงููููุดุฃุฉ
2. ุงุถุบุท ุนูู ุงูููุชุงุญ (Switch) ูุชุนุทูููุง
3. ุชุฃูุฏ ูู ุชุบููุฑ ุงูุญุงูุฉ
4. ุฃุนุฏ ุชูุนูููุง

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- โ ุชุบููุฑ ุงูุญุงูุฉ ููุฑุงู
- โ ุนุฏู ุชูููุฐ ุงูุฌุฏููุฉ ุนูุฏ ุงูุชุนุทูู

---

#### ุงูุงุฎุชุจุงุฑ 2.3: ุญุฐู ุฌุฏููุฉ
**ุงูุฎุทูุงุช:**
1. ุงุถุบุท ุนูู ุฃููููุฉ ุงูุญุฐู (๐๏ธ)
2. ุชุฃููุฏ ุงูุญุฐู

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- โ ุฑุณุงูุฉ ุชุฃููุฏ
- โ ุฅุฒุงูุฉ ุงูุฌุฏููุฉ ูู ุงููุงุฆูุฉ
- โ ุนุฏู ุชูููุฐูุง ูุณุชูุจูุงู

---

### 3๏ธโฃ ุงุฎุชุจุงุฑ ุชุญููู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ

#### ุงูุงุฎุชุจุงุฑ 3.1: ุชุญููู ูุณุฎุฉ ุงุญุชูุงุทูุฉ
**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ูุงุฆูุฉ ุงูุฎูุงุฑุงุช (โฎ) ููุณุฎุฉ completed
2. ุงุฎุชุฑ "ุชุญููู"
3. ุงูุชุธุฑ ุงูุชุญููู

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- โ ุชุญููู ููู JSON
- โ ุงุณู ุงูููู: `{backup_name}-{timestamp}.json`
- โ ุงูููู ุตุงูุญ (ูููู ูุชุญู)
- โ ูุญุชูู ุนูู ุจูุงูุงุช ุงูุฌุฏุงูู

**ุงูุชุญูู ูู ูุญุชูู ุงูููู:**
```json
{
  "awareness_campaigns": [...],
  "policies": [...],
  "grc_risks": [...]
}
```

---

### 4๏ธโฃ ุงุฎุชุจุงุฑ ุงูุงุณุชุนุงุฏุฉ (Restore)

#### ุงูุงุฎุชุจุงุฑ 4.1: ุงุณุชุนุงุฏุฉ ูุงููุฉ (Full Restore)
**โ๏ธ ุชุญุฐูุฑ:** ูุฐุง ุงูุงุฎุชุจุงุฑ ุณูุณุชุจุฏู ุงูุจูุงูุงุช ุงูุญุงููุฉ!

**ุงูุฎุทูุงุช:**
1. ุงูุชูู ุฅูู ุชุจููุจ "ุงูุงุณุชุนุงุฏุฉ"
2. ุงุฎุชุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ููุชููุฉ
3. ุงุฎุชุฑ ููุน ุงูุงุณุชุนุงุฏุฉ: "Full"
4. ุถุน ุนูุงูุฉ โ ุนูู "ุฃููู ุงููุฎุงุทุฑ"
5. ุงุถุบุท "ูุชุงุจุนุฉ"
6. ุชุฃููุฏ ุงูุงุณุชุนุงุฏุฉ

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- โ ุฑุณุงูุฉ: "ุจุฏุฃุช ุนูููุฉ ุงูุงุณุชุนุงุฏุฉ"
- โ ุณุฌู ุฌุฏูุฏ ูู ุฌุฏูู restore_logs
- โ ุงูุญุงูุฉ: running ุซู completed
- โ ุงุณุชุนุงุฏุฉ ุฌููุน ุงูุฌุฏุงูู ุจูุฌุงุญ

---

#### ุงูุงุฎุชุจุงุฑ 4.2: ุงุณุชุนุงุฏุฉ ุฌุฒุฆูุฉ (Partial Restore)
**ุงูุฎุทูุงุช:**
1. ููุณ ุฎุทูุงุช 4.1
2. ุงุฎุชุฑ ููุน ุงูุงุณุชุนุงุฏุฉ: "Partial"
3. ุงุฎุชุฑ ุฌุฏุงูู ูุญุฏุฏุฉ ููุงุณุชุนุงุฏุฉ

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- โ ุงุณุชุนุงุฏุฉ ุงูุฌุฏุงูู ุงููุญุฏุฏุฉ ููุท
- โ ุนุฏู ุงูุชุฃุซูุฑ ุนูู ุจุงูู ุงูุฌุฏุงูู

---

### 5๏ธโฃ ุงุฎุชุจุงุฑ ุญุฐู ุงููุณุฎ ุงููุฏููุฉ

#### ุงูุงุฎุชุจุงุฑ 5.1: ุญุฐู ูุณุฎุฉ ุงุญุชูุงุทูุฉ
**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ูุงุฆูุฉ ุงูุฎูุงุฑุงุช (โฎ) ููุณุฎุฉ
2. ุงุฎุชุฑ "ุญุฐู"
3. ุชุฃููุฏ ุงูุญุฐู

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- โ ุฑุณุงูุฉ: "ุชู ุงูุญุฐู ุจูุฌุงุญ"
- โ ุฅุฒุงูุฉ ุงูุณุฌู ูู ุงูุฌุฏูู
- โ ุญุฐู ุงูููู ูู Storage

---

### 6๏ธโฃ ุงุฎุชุจุงุฑ ุงูุตูุงุญูุงุช (Permissions)

#### ุงูุงุฎุชุจุงุฑ 6.1: ุตูุงุญูุงุช tenant_admin
**ุงููุฏู:** ุงูุชุฃูุฏ ูู ุฃู ูุฏูุฑ ุงููุณุชุฃุฌุฑ ููููู:
- โ ุนุฑุถ ุฌููุน ุงููุณุฎ ุงูุฎุงุตุฉ ุจูุณุชุฃุฌุฑู
- โ ุฅูุดุงุก ูุณุฎ ุงุญุชูุงุทูุฉ
- โ ุฌุฏููุฉ ูุณุฎ ุชููุงุฆูุฉ
- โ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
- โ ุญุฐู ุงููุณุฎ

#### ุงูุงุฎุชุจุงุฑ 6.2: ุตูุงุญูุงุช platform_admin
**ุงููุฏู:** ุงูุชุฃูุฏ ูู ุฃู ูุฏูุฑ ุงูููุตุฉ ููููู:
- โ ุนุฑุถ ุฌููุน ุงููุณุฎ ูุฌููุน ุงููุณุชุฃุฌุฑูู
- โ ููุณ ุตูุงุญูุงุช tenant_admin

#### ุงูุงุฎุชุจุงุฑ 6.3: ุนุฒู ุงูุจูุงูุงุช (Tenant Isolation)
**ุงููุฏู:** ุงูุชุฃูุฏ ูู ุนุฏู ุชุฏุงุฎู ุงูุจูุงูุงุช
- โ ูู ูุณุชุฃุฌุฑ ูุฑู ูุณุฎู ููุท
- โ ูุง ูููู ุงููุตูู ููุณุฎ ูุณุชุฃุฌุฑ ุขุฎุฑ

---

## ๐ง ุฅุนุฏุงุฏ Cron Jobs ููุฌุฏููุฉ ุงูุชููุงุฆูุฉ

### ุงูุทุฑููุฉ 1: ุนุจุฑ SQL Editor

```sql
-- 1. ุชูุนูู ุงูู Extensions ุงููุทููุจุฉ
CREATE EXTENSION IF NOT EXISTS pg_cron;
CREATE EXTENSION IF NOT EXISTS pg_net;

-- 2. ุฅูุดุงุก Cron Job ูููุณุฎ ุงูููููุฉ
SELECT cron.schedule(
  'daily-backup-2am',
  '0 2 * * *',
  $$
  SELECT net.http_post(
    url:='https://varbgkrfwbgzmkkxpqjg.supabase.co/functions/v1/backup-database',
    headers:='{"Content-Type": "application/json", "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhcmJna3Jmd2Jnem1ra3hwcWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0ODgwMjYsImV4cCI6MjA3ODA2NDAyNn0.Gak-v2bGOtViwnMjfIJSSkHavNvBxZd5bsyH878b3h4"}'::jsonb,
    body:='{"jobType": "full"}'::jsonb
  );
  $$
);

-- 3. ุงูุชุญูู ูู ุงูู Cron Jobs
SELECT * FROM cron.job;

-- 4. ุฅูุบุงุก Cron Job (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
SELECT cron.unschedule('daily-backup-2am');
```

### ุฃูุซูุฉ ุนูู Cron Expressions

```bash
# ูู ุณุงุนุฉ
0 * * * *

# ูู ููู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู
0 2 * * *

# ูู ุฃุญุฏ ุงูุณุงุนุฉ 3 ุตุจุงุญุงู
0 3 * * 0

# ูู ุณุงุนุชูู
0 */2 * * *

# ูู 6 ุณุงุนุงุช
0 */6 * * *
```

---

## ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก

### 1. ูุฑุงูุจุฉ Logs ููููุงู

```sql
-- ุขุฎุฑ 10 ุนูููุงุช ูุณุฎ ุงุญุชูุงุทู
SELECT 
  backup_name,
  status,
  started_at,
  completed_at,
  duration_seconds,
  backup_size_bytes,
  tables_count
FROM backup_jobs
ORDER BY created_at DESC
LIMIT 10;

-- ุงูุนูููุงุช ุงููุงุดูุฉ
SELECT 
  backup_name,
  error_message,
  error_details,
  started_at
FROM backup_jobs
WHERE status = 'failed'
ORDER BY started_at DESC;
```

### 2. ูุฑุงูุจุฉ ุญุฌู Storage

```sql
-- ุฅุฌูุงูู ุญุฌู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
SELECT 
  tenant_id,
  COUNT(*) as total_backups,
  SUM(backup_size_bytes) as total_size,
  AVG(duration_seconds) as avg_duration
FROM backup_jobs
WHERE status = 'completed'
GROUP BY tenant_id;
```

### 3. ุงุฎุชุจุงุฑ ุงูุงุณุชุนุงุฏุฉ ุงูุดูุฑู

- โ๏ธ **ุถุฑูุฑู ุฌุฏุงู**: ุงุฎุชุจุฑ ุนูููุฉ ุงูุงุณุชุนุงุฏุฉ ูุฑุฉ ูุงุญุฏุฉ ุดูุฑูุงู ุนูู ุงูุฃูู
- ุงุณุชุฎุฏู ุจูุฆุฉ ุงุฎุชุจุงุฑ ูููุตูุฉ
- ุชุฃูุฏ ูู ุตุญุฉ ุงูุจูุงูุงุช ุงูููุณุชุนุงุฏุฉ

---

## ๐ฏ ูุนุงููุฑ ุงููุฌุงุญ ุงูููุงุฆูุฉ

### ุงูุฃุฏุงุก
- โ ุงููุณุฎ ุงููุงูู: < 60 ุซุงููุฉ
- โ ูุนุฏู ุงููุฌุงุญ: > 99%
- โ ุญุฌู ุงููุณุฎุฉ: ููุทูู ููุงุฑูุฉ ุจุญุฌู ุงูุจูุงูุงุช

### ุงูููุซูููุฉ
- โ ุตูุฑ ุฃุฎุทุงุก ูู RLS
- โ ุนุฒู ูุงูู ุจูู ุงููุณุชุฃุฌุฑูู
- โ ูุฌุงุญ ุงูุงุณุชุนุงุฏุฉ 100%

### ุงูุฃูุงู
- โ ุฌููุน Policies ูููุนููุฉ
- โ ูุง ูููู ุงููุตูู ูููุณุฎ ุจุฏูู ุตูุงุญูุฉ
- โ ุชุดููุฑ ุงูุจูุงูุงุช ูู Storage

---

## ๐ ุณุฌู ุงูุงุฎุชุจุงุฑุงุช

### ูุงูุจ ุณุฌู ุงูุงุฎุชุจุงุฑ

| ุงูุชุงุฑูุฎ | ุงูุงุฎุชุจุงุฑ | ุงููุชูุฌุฉ | ุงูููุงุญุธุงุช |
|---------|----------|---------|-----------|
| 2025-11-18 | 1.1 Full Backup | โ Pass | - |
| 2025-11-18 | 2.1 Schedule | โ Pass | - |
| ... | ... | ... | ... |

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ุงููุณุฎุฉ ูุดูุช
**ุงูุญู:**
1. ุชุญูู ูู logs ุงูู Edge Function
2. ุชุญูู ูู RLS policies
3. ุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู

### ุงููุดููุฉ: ูุง ุชุธูุฑ ุงููุณุฎ ูู ุงูุฌุฏูู
**ุงูุญู:**
1. ุชุญูู ูู tenant_id
2. ุชุญูู ูู user_tenants mapping
3. ุงูุญุต RLS policies

### ุงููุดููุฉ: ูุดู ุงูุชุญููู
**ุงูุญู:**
1. ุชุญูู ูู ูุฌูุฏ ุงูููู ูู Storage
2. ุชุญูู ูู storage policies
3. ุชุฃูุฏ ูู ุงูุชูุงู ุงููุณุฎุฉ (status = completed)

---

## โ Checklist ุงูููุงุฆู

ูุจู ูุดุฑ ุงููุธุงู ูู ุงูุฅูุชุงุฌ:

- [ ] ุฌููุน ุงูุงุฎุชุจุงุฑุงุช 1.1 - 6.3 ุชูุช ุจูุฌุงุญ
- [ ] Cron Jobs ูููุนููุฉ ูุชุนูู
- [ ] ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูููุนููุฉ
- [ ] ุณูุงุณุงุช RLS ูุญุฏุซุฉ ูุขููุฉ
- [ ] Storage policies ูุญุฏุซุฉ
- [ ] ุชู ุงุฎุชุจุงุฑ ุงูุงุณุชุนุงุฏุฉ ุงููุงููุฉ
- [ ] ุชู ุชูุซูู ุฌููุน ุงูุฅุนุฏุงุฏุงุช
- [ ] ูุฑูู ุงูุฏุนู ููุฏุฑูุจ ุนูู ุงููุธุงู

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูุฏููู ูู:** 2025-11-18  
**ุงูุฅุตุฏุงุฑ:** 1.0  
**ุงูููุฑุงุฌุน ุงูุชุงูู:** 2025-12-18
